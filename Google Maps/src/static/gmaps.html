
<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
        <meta charset="utf-8">
        <style type="text/css">
            html { height: 100% }
            body { height: 100%; margin: 0; padding: 0 }
            .status_bar {
                position: absolute;
                bottom: 0;
                height: 18px;
                width: 100%;
                background: #FAFAFA;
                border-top: 1px solid #F0F0F0;
                z-index: 10;
            }
            .status_bar span.message { float: right; }
            .contextmenu {
                visibility: hidden;
                background: #FEFEFE;
                border: 2px solid #FAFAFA;
                z-index: 10;
                position: relative;
                width: 140px
            }
            .btn {
                width: 100%;
                height: 100%;
                border: none;
                background: #FEFEFE;
                outline: 0;
                text-align: left;
            }
            .btn:hover { background: #F0F0F0; }
            #map_canvas { height: 100% }
        </style>
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDUqZDJn8yWjIKJ4nUsHQGuEAvZHar41rs&sensor=false"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script type="text/javascript">
            var map;
            var poly;
            var infoWindow;
            var marker;
            var isContextMenuOpen;
            var currentPosition;
            var altitudeArray;

            function initialize() {
                var mapCenter = new google.maps.LatLng(0,0);

                var mapOptions = {
                    zoom: 5,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    center: mapCenter,
                    disableDefaultUI: true
                };
                map = new google.maps.Map(document.getElementById('map_canvas'),mapOptions);

                altitudeArray = [];
                currentPosition = mapCenter;

                var markerOptions = {
                    position: currentPosition
                };
                marker = new google.maps.Marker(markerOptions);
                marker.setMap(map);

                infoWindow = new google.maps.InfoWindow();
                isContextMenuOpen = false;
        
                var polyOptions = {
            
                    strokeColor: '#000000',
                    strokeWeight: 3,
                    strokeOpacity: 1.0
                };
                poly = new google.maps.Polyline(polyOptions);
                poly.setEditable(true);
                poly.setMap(map);
                poly.binder = new MVCArrayBinder(poly.getPath());
            
                // Makes sure altitdue array and path array are in sync
                google.maps.event.addListener(poly.getPath(), 'insert_at', function(index) {
                    if(index == (poly.getPath().getLength() - 1))
                        altitudeArray.push(index);
                    else {
                        var tmp = [];
                        for(var i = 0; i < index; i++)
                            tmp[i] = altitudeArray[i];
                        tmp[index] = index;
                        for(var i = index+1; i <= altitudeArray.length; i++)
                            tmp[i] = altitudeArray[i-1];
                        altitudeArray = tmp;
                    }
                });
                google.maps.event.addListener(poly.getPath(), 'remove_at', function(index) {
                    if(index == 0)
                        altitudeArray.shift();
                    else if(index == (poly.getPath().getLength() - 1))
                        altitudeArray.pop();
                    else {
                        var tmp = [];
                        for(var i = 0; i < index; i++)
                            tmp[i] = altitudeArray[i];
                        for(var i = index+1; i < altitudeArray.length; i++)
                            tmp[i-1] = altitudeArray[i];
                        altitudeArray = tmp;
                    }
                });
                google.maps.event.addListener(poly.getPath(), 'set_at', function(event) {
                    /*
                    ** PLACE HOLDER
                    ** CODE HERE
                    */
                });

                google.maps.event.addListener(map, 'click', addPoint);
                google.maps.event.addListener(map, 'rightclick', showContextMenu);
                google.maps.event.addListener(map, 'mousemove', statusBarCoordinate);
                google.maps.event.addListener(poly, 'click', showCoordinate);
                google.maps.event.addListener(poly, 'rightclick', showContextMenu);
                google.maps.event.addListener(marker, 'rightclick', showContextMenu);
            } // end of initialize()

            function showCoordinate(event) {
                var index = poly.getPath().getArray().indexOf(event.latLng);
                var message = "Longitude: " + event.latLng.lat() + "<br />";
                message += "Latitude: " + event.latLng.lng() + "<br />";
                message += "Altitude: " + altitudeArray[index] + "<br />";
                infoWindow.setContent(message);
                infoWindow.setPosition(event.latLng);
                infoWindow.open(map);
            }

            function addPoint(event) {
                if(isContextMenuOpen) {
                    $('.contextmenu').remove();
                    isContextMenuOpen = false;
                    return;
                }
                // All arrays are passed by reference in js
                var path = poly.getPath();
                path.push(event.latLng);
            }

            function statusBarCoordinate(event) {
                $('span.message').html(event.latLng.lat() + ", " + event.latLng.lng());
            }

            function showContextMenu(event) {
                $('.contextmenu').remove(); // remove existing menu when right clicked again
                var contextmenu;
                var position = event.latLng;
                contextmenu = document.createElement('div');
                contextmenu.className = 'contextmenu';
                contextmenu.innerHTML = "<button type=\"button\" id=\"item1\" class=\"btn\">Send Coordinates</button>";
                contextmenu.innerHTML += "<button type=\"button\" id=\"item2\" class=\"btn\">Circle Here</button>";
                contextmenu.innerHTML += "<button type=\"button\" id=\"item3\" class=\"btn\">Refresh</button>";
                contextmenu.innerHTML += "<button type=\"button\" id=\"item4\" class=\"btn\">Remove point</button>";
                contextmenu.innerHTML += "<button type=\"button\" id=\"item5\" class=\"btn\">Loiter Here</button>";
                $(map.getDiv()).append(contextmenu);

                var clickedPosition = latLngToXY(position);
                $('.contextmenu').css('left', clickedPosition.x);
                $('.contextmenu').css('top', clickedPosition.y);

                contextmenu.style.visibility = "visible";

                isContextMenuOpen = true;

                // add event listeners
                // SEND COORDINATES
                $('#item1').click(function() {
                    var data = poly.getPath().getArray();
                    var coordArray = $.map(data, function(coord){
                        return {
                            lat: coord.lat(),
                            lng: coord.lng(),
                            type: "waypoint"
                        }
                    });
                    console.log(poly.getPath().getArray());
                    $.post("http://localhost:5000",
                    {
                        "data": coordArray
                    });
                    contextmenu.style.visibility = "hidden";
                }); // end item1 event handler

                // CIRCLE HERE
                $('#item2').click(function() {
                    var scale = 1.5
                    var circlePathCoord = [
                        // current position
                        new google.maps.LatLng(currentPosition.lat(), currentPosition.lng()),

                        // top right corner
                        new google.maps.LatLng(position.lat()+scale, position.lng()+scale),

                        // top left corner
                        new google.maps.LatLng(position.lat()+scale, position.lng()-scale),

                        // middle left corner
                        new google.maps.LatLng(position.lat(), position.lng()-scale),

                        // bottom left corner
                        new google.maps.LatLng(position.lat()-scale, position.lng()-scale),

                        // bottom right corner
                        new google.maps.LatLng(position.lat()-scale, position.lng()+scale),

                        // middle right corner
                        new google.maps.LatLng(position.lat(), position.lng()+scale),

                        // connect line to first point
                        new google.maps.LatLng(position.lat()+scale, position.lng()+scale)
                    ];
                    poly.setPath(circlePathCoord);
                    currentPosition = circlePathCoord[1];
                    marker.setPosition(circlePathCoord[1]);

                    contextmenu.style.visibility = "hidden";
                }); // end #item2 event handler

                // REFRESH PAGE
                $('#item3').click(function() {
                    location.reload();
                }); // end #item3 event handler

                // DELETE POINT
                $('#item4').click(function() {
                    var path = poly.getPath();
                    var index = path.getArray().indexOf(position);
                    if(index != -1)
                        path.removeAt(index);
                    else
                        alert('point not in path');
                    contextmenu.style.visibility = "hidden";
                }); // end of #item4 event handler

                // LOITER HERE
                $('#item5').click(function() {
                    if(position.equals(currentPosition)) {
                        marker.setPosition(position);
                        currentPosition = position;
                    }
                    else {
                        var tmpPath = [
                            new google.maps.LatLng(currentPosition.lat(), currentPosition.lng()),
                            new google.maps.LatLng(position.lat(), position.lng())
                        ];
                        poly.setPath(tmpPath);
                        marker.setPosition(position);
                        currentPosition = position;
                    }
                    contextmenu.style.visibility = "hidden";
                }); //  end of #item5 event handler

                contextmenu.style.visibility = "visible";
            }

            function latLngToXY(latlng) {
                var scale = Math.pow(2, map.getZoom());
                var nwLatLng = new google.maps.LatLng(
                    map.getBounds().getNorthEast().lat(),
                    map.getBounds().getSouthWest().lng()
                );
                var nwPoint = map.getProjection().fromLatLngToPoint(nwLatLng);
                var clickPoint = map.getProjection().fromLatLngToPoint(latlng);
                var offset = new google.maps.Point(
                    (clickPoint.x - nwPoint.x) * scale,
                    (clickPoint.y - nwPoint.y) * scale
                );

                return offset;
            }

            function MVCArrayBinder(pathArray) {
                this.array_ = pathArray;
            }
            MVCArrayBinder.prototype = new google.maps.MVCObject();
            MVCArrayBinder.prototype.get = function(key) {
                if(!isNaN(parseInt(key)))
                    return this.array_.getAt(parseInt(key));
                else
                    return this.array_.get(key);
            }
            MVCArrayBinder.prototype.set = function(key, val) {
                if(!isNan(parseInt(key)))
                    this.array_.setAt(parseInt(key), val);
                else
                    this.array_.set(key, val);
            }
            </script>
    </head>
    <body onload="initialize()">
        <div id="map_canvas" style="width: 100%; height: 100%;"></div>
        <div class="status_bar">
            <span class="message"></span>
        </div>
    </body>
</html>
        